# 渋谷スクランブル交差点の交通量調査プレゼンテーション

# 目次

- 概要
- 目的
- モデルの用途と車両の種類の定義
- モデルの選定
- 使用した学習データ
- 訓練データの作成方法
- モデルの学習と検証方法
- モデルアンサンブル
- 作成したグラフ
- 工夫点
- 悩んだ事
- 今後の施策

# 概要

- 文化の発信地である渋谷では多種多様な車両を見かけることができます。あなたはデータサイエンティストとして、まずは「車両の種類」を定義し、写真内から「種類ごとに車両を検出・カウントするモデル」を作成してほしいと依頼を受けました。
- そのモデルを用いて、平日・休日の計48時間ぶんの画像から、各時刻にどの種類の車が何台いるかをカウントしてグラフ化したいです。

# 目的

- 背景に添って以下の事を行う
    - モデルの用途と車両の種類の定義
    - 定義した車両を検出するモデルの作成
    - モデルの出力を基に csvファイル(列：写真ファイル名、車両の種類、数)とグラフの作成

## モデルの用途と車両の種類の定義

- 今回は交通量調査を目的と仮定しました。
    - 分類の決め方
        - 画像に出てきた車両を確認し、下記の表のように分類を行う事にしました。
    
    | ラベル名 |  |
    | --- | --- |
    | ambulance | 救急車 |
    | bicycle | 自転車 |
    | bus | バス |
    | cab | タクシー |
    | car | 乗用車 |
    | garbage truck | ゴミ収集車 |
    | go-cart | ゴーカート |
    | go-carts | 複数のゴーカート |
    | motorcycle | バイク |
    | police car | 警察車両 |
    | truk | トラック |

## モデルの選定

- 物体検出のタスクが初めてだったので。今回は実装が比較的簡単で、参考記事も豊富なYOLOv8をまずは実装してみる事にしました。
    
    ### YOLOv8の検出手法
    
    - YOLOv8は、物体検出タスクにおいて高い性能を発揮するディープラーニングモデルです。
    - 物体検出とは、画像内の物体を特定し、その位置をバウンディングボックス（矩形）で囲み、それぞれの物体にラベルを付けるタスクです。
    - YOLOv8の実装については、Readmeを確認してください

## 使用した学習データ

- 学習データとしてFY25Spring_Quest_AI_Data.zipの以下のデータを使用しました。
    - 20240512_000000.jpg~20240512_010000.jpgの61枚
    - 20240512_040000.jpg~20240512_050000.jpgの61枚
    - 20240512_070000.jpg~20240512_080000.jpg + 20240512_080700.jpgの61枚※
    - 20240512_120000.jpg~20240512_130000.jpgの61枚
    - 20240512_170000.jpg~20240512_180000.jpgの61枚
    - 20240512_210000.jpg~20240512_220000.jpgの61枚
    
    ※20240512_07040.jpgが無かったため、別の画像で補完しました。
    

## 訓練データの作成方法

- 物体検出のためのアノテーションツールであるLabelStudioを使用し、366枚分アノテーションを行いました。
- 詳しくはReadmeを確認してください

## モデルの学習と検証方法

- モデルの訓練のための学習データの分割方法として以下の3つを順に行いました。最終的には層化K分割交差検証法を採用しています。
    - ホールドアウト法
        - 学習データを訓練データとテストデータの2つに分割する。
        - 詳しいコードは[こちら](../hold-out_code/hold-out.py)を参照してください
    - K-分割交差検証法
        - 学習データをK個の等しいサイズに分割し、それぞれをテストセットとして使用し、残りをトレーニングセットとして使用することで、モデルの性能を評価する
        - 詳しいコードは[こちら](../k-fold_code/cross_validation.py)を参照してください
    - 層化K分割交差検証法
        - K分割交差検証の一種。データセットをK個に分割する際に、各部分が元の学習データのクラス比率と同じようにする方法
        - 詳しいコードは[こちら](../StatifiedKFold_code/StratifiedKFold.py)を参照してください

### ホールドアウト法

- **実装理由**
    
    実際に検証して必要な対策を検討したかったため、実装が簡単なこちらを初めに行いました。
    
- **実装した結果画像の一部**
    
    
    labels.jpg
    ![labels.jpg](doc/Presentation Images)
    
    PR_curve.png
    
    result.png
    
    F1_curve.png
    

### 結果の考察

- 上記の画像から以下の事が読み取れます
1. クラス間のデータ不均衡
    - **現象**: 車や救急車などのクラスに対して非常に高い精度を示す一方で、ゴーカートやバイクなどのクラスでは低い精度を示している。
    - **原因**: 学習データ内のクラス間の数に大きな不均衡があるため、過学習や学習不足を起こしている可能性が高い。
    - **対策案**: データのバランスを取るために、アンダーサンプリングやオーバーサンプリング、データ拡張、追加でデータのアノテーションを行う。
2. 特定クラス間での誤分類
    - **現象**: タクシー（Cab）と車（Car）の間で多くの誤分類が見られる。
    - **原因**: これらのクラスが視覚的に類似しているため、特徴抽出が困難になっている可能性がある。また、訓練データにおけるクラスの明確な区別が不足していることも考えられる。
    - **対策案**: タクシーと車で乗用車に統一を行うか、有識者に判断してもらい、教師データを作り直す。
3. 信頼度とパフォーマンスの急激な低下
    - **現象**: 高い信頼度の範囲で急激にF1スコアが低下する場合がある。
    - **原因**: 上記でも挙げたデータ不均衡や、ハイパーパラメータの不適切な設定が原因として挙げられる。
    - **対策案**: クラス間のデータ不均衡と同じ対策やハイパーパラメータの見直し、アンサンブル学習を用いてモデルの出力を安定させることも考えられます。
    
    ### **対策方針**
    
    データ不均衡を無くすために出来れば画像枚数を増やしたいが、GPUの処理能力もギリギリなので、k-分割交差検証法で過学習やデータの偏りを軽減する事を目指す事にしました。
    

### K-分割交差検証法

- **実装理由**
    - データの分布が偏っていても、この手法を用いることで過学習やデータの偏りの影響を軽減出来るため
- **実装した結果画像の一部**
    
    
    result.png
    
    train1_PR_curve.png
    
    result2.png
    
    train2_PR_curve.png
    

### 結果の考察

- 各foldを比較した際の問題点として以下が挙げられます
    - 特徴量のばらつきと相関
        - **現象**: 各foldのグラフで大きな差が出ており、期待していた過学習やデータの偏りの影響を軽減出来ていない
        - **原因**: ホールドアウト法でも挙がっていた、クラス間のデータ不均衡が深刻であり、各foldに分けた際にクラス間のバラつきが起きているため
        - **対策案**: ホールドアウト法で述べた対策案や層化K分割交差検証法を使用して、各fold内のクラス分布を全体のクラス分布と一致させる。アンサンブル学習を行い全体の予測精度を向上させます。
    
    ### **対策方針**
    
    上記のK-分割交差検証法の対策案の通りに層化K分割交差検証法を行い、各foldのアンサンブル学習を行う
    

### 層化K分割交差検証法

- **実装理由**
    
    データセットをK個の部分に分割する際に、各部分が全体のクラス分布を保つように分割するため、各fold内のクラス分布が全データセットのクラス分布と同じになる。これによりデータ不均衡を軽減出来る
    
- **実装した結果画像の一部**

result1

result2

PR_curve1.png

PR_curve2.png

### 結果の考察

- **良い点**
    1. **クラス間のデータ不均衡の改善**
        - 各fold間のグラフが似た形状を取っているため、クラス間のデータ不均衡が改善されています。
    2. **学習曲線の安定性**
        - K-分割交差検証法と比較してtrainおよびvalのloss曲線がより安定しており、過学習や学習不足の兆候が減少しています。
- **悪い点**
    1. **クラスの過剰適合**
        - 層化によってクラスのバランスを保つために、特定のクラスに対する過剰適合が発生するリスクがあり、特に救急車や警察車両などは与えた学習データの枚数に対して精度が高すぎるので、過剰適合の可能性が高そうです。
    2. **計算コスト**
        - K分割交差検証法自体が計算リソースを多く消費する手法ですが、層化K分割交差検証法はさらにクラスのバランスを考慮するため、今後学習データを増やした際に計算コストが問題になると考えられます。

## モデルアンサンブル

### 今回のアンサンブルの手順

- 上記の層化K分割交差検証法の各foldでモデルを作成
- 作成したモデルでテストデータに対しての結果を各モデル毎に出力
- 出力した結果をWeighted-Boxes-Fusionを用いてアンサンブル
- アンサンブルした結果から中心座標が0.01の範囲で重複しているboxがある場合scoreが高い方を残す処理

### Weighted-Boxes-Fusion

- 複数の物体検出モデルからの検出ボックスをアンサンブル（結合）するための手法を提供しています。
- 詳しくはReadmeを確認してください

## 作成したグラフ

- 1分毎の棒グラフと折れ線グラフ
- 1時間毎の棒グラフと折れ線グラフ

## 工夫点

- **車両の決め方**
    - ゴーカートの集団がお昼~夜にかけてよく通っていました。
    - 集団で走行しているので人の目で見ても何台か判別は難しく、誤検出の原因になり得ると考えたので、go-cartsでまとめました。
- **学習データの選定**
    - 今回与えられた画像データ2,880枚を全てアノテーションするのは時間的に難しいので、以下のように時間帯を分けたデータを使う事でデータの分布の偏りが抑えられるのではないかと考えました。
        
        
        | 深夜 | 0時~1時 |
        | --- | --- |
        | 早朝 | 4時~5時 |
        | 朝 | 7時~8時 |
        | 昼 | 12時~13時 |
        | 夕方 | 17時~18時 |
        | 夜 | 21時~22時 |

## 悩んだ事

- **アンサンブルの手法**
    - YOLOv5にはアンサンブルの機能がありましたが、v8にはないため、自分でアンサンブルをする必要がありました。
    - Weighted-Boxes-Fusionにより、これを解決しました。
- **GPUの性能について**
    - GPUに結構負荷がかかってしまったので、何度かクラッシュを起こしてしまいました。
    - 上記の工夫点で述べたのと同様に、学習データの選定を行う事、引数の調整を行う事で負荷を抑えました。

## 今後の施策

- **他の事前学習モデルと比較する**
    - 今回は時間の関係上で実装出来ませんでしたが、DETR, SSD,最新のYOLOv10などを使用し、比較を行う事で適したモデルを見つける事が出来ると考えています。
- **車両の種類の再定義**
    - 今回の画像はナンバープレートを確認出来るような状態ではなかったため、主観で車両の定義を決めてしまいました。
    - ナンバープレートが見える画像の提示を求める事で、国土交通省の道路交通量調査共通仕様書に基づきしっかり定義を決める事が出来ると考えています。
- **学習データの増加**
    - 学習データが今回は少なかったため、データ拡張、追加でデータのアノテーションを行う事で性能の向上が見込めます。
    - そのためには既存のGPUの強化やGoogleColabの有料プランで動かす事で安定して画像の処理が行えると思います。
